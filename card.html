<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Page</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .image-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-image {
            width: 100%;
            max-width: 540px;
            max-height: calc(100vh - 48px);
            height: auto;
            display: block;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            object-fit: contain;
        }

        .text-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        @media (max-width: 768px) {
            .container {
                padding: 24px 15px;
            }
            
            .card-image {
                max-width: 100%;
            }
            
            .text-overlay {
                font-size: 18px;
                padding: 12px 20px;
            }
        }

        @media (max-width: 480px) {
            .text-overlay {
                font-size: 16px;
                padding: 10px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="image-container">
            <img id="cardImage" src="" alt="Card Image" class="card-image">
            <span id="textOverlay" class="text-overlay"></span>
        </div>
    </div>

    <script>
        // Image data (equal probability for all images)
        const images = [
            "assets/images/S__172548136.jpg",
            "assets/images/S__172548137.jpg",
            "assets/images/S__172548138.jpg",
            "assets/images/S__172548139.jpg",
            "assets/images/S__172548140.jpg"
        ];

        // Google Sheets CSV URL with CORS proxy
        const SHEET_ID = '1ecyT2EcO6shL61eaANXyIS4izuQPlL4eWwJt07GwHPE';
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        const TEXT_PROBABILITY_SHEET_URL = CORS_PROXY + encodeURIComponent(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`);
        
        // Fallback texts with equal probabilities
        const fallbackTexts = [
            { text: "‰ªäÂ§©ÂæàÈñãÂøÉ", probability: 0.2 },
            { text: "Êò®Â§©ÂæàÁæéÂ•Ω", probability: 0.2 },
            { text: "ÂæàÊúüÂæÖÊòéÂ§©", probability: 0.2 },
            { text: "ÈÄôÂÖ©Â§©ÈÉΩÊòØÂ•ΩÂ§©Ê∞£", probability: 0.2 },
            { text: "ÊúÉÊòØ‰∏ÄÂÄãÂ•ΩÂπ¥ÁöÑÔºÅ", probability: 0.2 }
        ];

        // Global texts array that will be populated from sheets or fallback
        let texts = [...fallbackTexts];

        function getRandomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        // Weighted random selection for texts based on probabilities
        function getWeightedRandomText(texts) {
            const totalWeight = texts.reduce((sum, textObj) => sum + textObj.probability, 0);
            let random = Math.random() * totalWeight;

            for (let textObj of texts) {
                random -= textObj.probability;
                if (random <= 0) {
                    return textObj;
                }
            }

            // Fallback to last text if something goes wrong
            return texts[texts.length - 1];
        }

        // Validate if CSV data looks like text probability data (2 columns: text, number)
        function validateTextProbabilitySheet(csvData) {
            const lines = csvData.trim().split('\n');
            if (lines.length === 0) return false;

            // Check first few lines for expected format
            let validLines = 0;
            for (let i = 0; i < Math.min(3, lines.length); i++) {
                const parts = lines[i].split(',').map(part => part.replace(/^\"|\"$/g, '').trim());
                if (parts.length >= 2) {
                    const probability = parseFloat(parts[1]);
                    if (!isNaN(probability) && probability > 0) {
                        validLines++;
                    }
                }
            }

            const isValid = validLines > 0;
            console.log(`üîç Text probability sheet validation: ${isValid ? '‚úÖ VALID' : '‚ùå INVALID'} (${validLines}/${Math.min(3, lines.length)} lines have text with numeric probabilities)`);
            return isValid;
        }

        // Parse CSV data for text probabilities
        function parseTextProbabilityCSV(csvData) {
            const lines = csvData.trim().split('\n');
            const textsFromSheet = [];

            console.log('üìä Raw CSV data from "ÈáëÂè•" sheet (expecting text,probability format):');
            console.log(csvData);
            console.log('üìã Expected format: "Text content,0.5" (text in column 1, probability number in column 2)');

            // Validate sheet format
            if (!validateTextProbabilitySheet(csvData)) {
                console.warn('‚ö†Ô∏è  Warning: CSV data does not appear to have probabilities in column 2!');
                console.warn('Current data appears to have text,S__identifier format instead of text,probability');
                console.warn('Please update the sheet to have probability numbers in column 2');
            }

            console.log('üìã Processing CSV lines:');

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                console.log(`Line ${i + 1}: "${line}"`);

                // Handle CSV parsing - split by comma and clean quotes
                const parts = line.split(',').map(part => part.replace(/^\"|\"$/g, '').trim());
                console.log(`  Raw parts: [${parts.map(p => `"${p}"`).join(', ')}]`);

                if (parts.length >= 2) {
                    const text = parts[0];
                    const secondColumn = parts[1];
                    const probability = parseFloat(secondColumn);

                    console.log(`  ‚Üí Text: "${text}"`);
                    console.log(`  ‚Üí Second column: "${secondColumn}"`);
                    console.log(`  ‚Üí Parsed as number: ${probability} (valid: ${!isNaN(probability)})`);

                    if (text && !isNaN(probability) && probability > 0) {
                        textsFromSheet.push({ text: text, probability: probability });
                        console.log(`  ‚úÖ Added: "${text}" = ${probability}`);
                    } else {
                        console.log(`  ‚ùå Skipped: ${!text ? 'empty text' : isNaN(probability) ? 'second column is not a valid number' : 'probability <= 0'}`);
                    }
                } else if (parts.length === 1 && parts[0]) {
                    // Handle single column case
                    const text = parts[0];
                    console.log(`  ‚Üí Single column text: "${text}"`);
                    console.log(`  ‚ùå Skipped: no probability column found`);
                } else {
                    console.log(`  ‚ùå Skipped: insufficient data`);
                }
            }

            console.log('üéØ Final texts with probabilities:', textsFromSheet);
            console.log(`üìà Successfully parsed ${textsFromSheet.length} texts with valid probabilities`);

            return textsFromSheet.length > 0 ? textsFromSheet : fallbackTexts;
        }


        // Clear all caches (for debugging/development)
        function clearAllCaches() {
            localStorage.removeItem('card_texts_probabilities_cache');
            localStorage.removeItem('card_texts_probabilities_cache_time');
            localStorage.removeItem('card_texts_cache');
            localStorage.removeItem('card_texts_cache_time');
            localStorage.removeItem('card_probabilities_cache');
            localStorage.removeItem('card_probabilities_cache_time');
            console.log('üóëÔ∏è  All caches cleared - will fetch fresh data from Google Sheets');
        }

        // Load texts with probabilities from Google Sheets with caching
        async function loadTextsWithProbabilities() {
            const CACHE_KEY = 'card_texts_probabilities_cache';
            const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes in milliseconds

            try {
                // Check cache first
                const cached = localStorage.getItem(CACHE_KEY);
                const cacheTime = localStorage.getItem(CACHE_KEY + '_time');

                if (cached && cacheTime) {
                    const age = Date.now() - parseInt(cacheTime);
                    if (age < CACHE_DURATION) {
                        console.log('üìö Using cached texts with probabilities (cached ' + Math.round(age/1000) + ' seconds ago)');
                        console.log('üí° To fetch fresh data, open browser console and run: clearAllCaches(); then refresh');
                        texts = JSON.parse(cached);
                        logTextSummary();
                        return;
                    } else {
                        console.log('‚è∞ Cache expired, fetching fresh data...');
                    }
                } else {
                    console.log('üì• No cache found, fetching fresh data...');
                }

                // Fetch from Google Sheets
                console.log('üîó Fetching texts with probabilities from "ÈáëÂè•" sheet (gid=0)...');
                const response = await fetch(TEXT_PROBABILITY_SHEET_URL);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const csvData = await response.text();
                const newTexts = parseTextProbabilityCSV(csvData);

                // Update texts and cache
                texts = newTexts;
                localStorage.setItem(CACHE_KEY, JSON.stringify(newTexts));
                localStorage.setItem(CACHE_KEY + '_time', Date.now().toString());

                console.log(`üéâ Successfully loaded ${texts.length} texts with probabilities from Google Sheets!`);
                logTextSummary();

            } catch (error) {
                console.error('‚ùå Failed to load texts from "ÈáëÂè•" sheet:', error.message);
                console.log('üìã Error details:', {
                    url: TEXT_PROBABILITY_SHEET_URL,
                    gid: '0',
                    sheetName: 'ÈáëÂè•'
                });
                console.log('üîÑ Using fallback hardcoded texts with equal probabilities');
                texts = [...fallbackTexts];

                // Clear invalid cache
                localStorage.removeItem(CACHE_KEY);
                localStorage.removeItem(CACHE_KEY + '_time');
            }
        }

        // Log summary of text probabilities
        function logTextSummary() {
            const totalProbability = texts.reduce((sum, textObj) => sum + textObj.probability, 0);
            console.log('‚ú® Final text probabilities:');
            texts.forEach(textObj => {
                const percentage = ((textObj.probability / totalProbability) * 100).toFixed(1);
                console.log(`  üìù "${textObj.text}": ${textObj.probability} (${percentage}%)`);
            });
            console.log(`üìä Total probability weight: ${totalProbability}`);
        }

        function initializeCard() {
            const randomImage = getRandomItem(images);
            const randomText = getWeightedRandomText(texts);

            console.log(`üñºÔ∏è  Selected image: ${randomImage} (random selection)`);
            console.log(`üìù Selected text: "${randomText.text}" (probability: ${randomText.probability})`);

            document.getElementById('cardImage').src = randomImage;
            document.getElementById('textOverlay').textContent = randomText.text;
        }

        // Initialize the application
        async function initializeApp() {
            console.log('üöÄ Initializing Card Application...');
            console.log('üìö Google Sheets Configuration:');
            console.log(`  Sheet ID: ${SHEET_ID}`);
            console.log(`  "ÈáëÂè•" sheet (with probabilities): gid=0`);

            // Load texts with probabilities
            await loadTextsWithProbabilities();

            // Summary
            console.log('üìä Initialization Summary:');
            console.log(`  Available texts: ${texts.length}`);
            console.log(`  Available images: ${images.length} (equal probability)`);
            const totalTextWeight = texts.reduce((sum, textObj) => sum + textObj.probability, 0);
            console.log(`  Total text probability weight: ${totalTextWeight}`);

            // Then initialize the card
            initializeCard();
            console.log('‚úÖ Card application ready!');
        }

        // Make functions available globally for debugging
        window.clearAllCaches = clearAllCaches;
        window.initializeApp = initializeApp;

        // Initialize the card when page loads
        window.addEventListener('load', initializeApp);

        // Optional: Click to change both image and text
        document.querySelector('.image-container').addEventListener('click', initializeCard);
    </script>
</body>
</html>